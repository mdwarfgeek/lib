#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#include "cvtunit.h"
#include "lfa.h"

struct dtdb_coef {
  double c;
  double omega;
  double phi;
};

static double dtdb_sum (double t, const struct dtdb_coef *list, int n) {
  double rv = 0.0;
  int i;

  for(i = n-1; i >= 0; i--)
    rv += list[i].c * sin(list[i].omega * t + list[i].phi);

  return rv;
}

/* Returns TDB-TT (in seconds) for a given TT (expressed as MJD).  Uses the
   approximate analytic formula from Fairhead & Bretagnon (1990) for the
   geocentric part, and the approximate treatment by Moyer (1981) for
   the topocentric part, with the fundamental arguments from Simon (1994)
   truncated to first order.  Results should be accurate to a few 100ns,
   limited by the truncation in the F&B formula. */

double dtdb (double mjd,        /* TDB as MJD (but TT is adequate) */
	     double dut1,       /* TT-UT1, s */
	     double longitude,  /* rad, East + */
	     double u,          /* distance from Earth spin axis, m */
	     double z) {        /* distance from Earth equatorial plane, m */
  /* Fairhead & Bretagnon (1990) coefficients */
  static const struct dtdb_coef acoef[] = {
    { 1656.674564,   6283.075943033, 6.240054195 },
    {   22.417471,   5753.384970095, 4.296977442 },
    {   13.839792,  12566.151886066, 6.196904410 },
    {    4.770086,    529.690965095, 0.444401603 },
    {    4.676740,   6069.776754553, 4.021195093 },
    {    2.256707,    213.299095438, 5.543113262 },
    {    1.694205,     -3.523118349, 5.025132748 },
    {    1.554905,  77713.772618729, 5.198467090 },
    {    1.276839,   7860.419392439, 5.988822341 },
    {    1.193379,   5223.693919802, 3.649823730 },
    {    1.115322,   3930.209696220, 1.422745069 },
    {    0.794185,  11506.769769794, 2.322313077 },
    {    0.600309,   1577.343542448, 2.678271909 },
    {    0.496817,   6208.294251424, 5.696701824 },
    {    0.486306,   5884.926846583, 0.520007179 },
    {    0.468597,   6244.942814354, 5.866398759 },
    {    0.447061,     26.298319800, 3.615796498 },
    {    0.435206,   -398.149003408, 4.349338347 },
    {    0.432392,     74.781598567, 2.435898309 },
    {    0.375510,   5507.553238667, 4.103476804 },
    {    0.243085,   -775.522611324, 3.651837925 },
    {    0.230685,   5856.477659115, 4.773852582 },
    {    0.203747,  12036.460734888, 4.333987818 },
    {    0.173435,  18849.227549974, 6.153743485 },
    {    0.159080,  10977.078804699, 1.890075226 },
    {    0.143935,   -796.298006816, 5.957517795 },
    {    0.137927,  11790.629088659, 1.135934669 },
    {    0.119979,     38.133035638, 4.551585768 },
    {    0.118971,   5486.777843175, 1.914547226 },
    {    0.116120,   1059.381930189, 0.873504123 },
    {    0.101868,  -5573.142801634, 5.984503847 },
    {    0.098358,   2544.314419883, 0.092793886 },
    {    0.080164,    206.185548437, 2.095377709 },
    {    0.079645,   4694.002954708, 2.949233637 },
    {    0.075019,   2942.463423292, 4.980931759 },
    {    0.064397,   5746.271337896, 1.280308748 },
    {    0.063814,   5760.498431898, 4.167901731 },
    {    0.062617,     20.775395492, 2.654394814 },
    {    0.058844,    426.598190876, 4.839650148 },
    {    0.054139,  17260.154654690, 3.411091093 },
    {    0.048373,    155.420399434, 2.251573730 },
    {    0.048042,   2146.165416475, 1.495846011 },
    {    0.046551,     -0.980321068, 0.921573539 },
    {    0.042732,    632.783739313, 5.720622217 },
    {    0.042560, 161000.685737473, 1.270837679 },
    {    0.042411,   6275.962302991, 2.869567043 },
    {    0.040759,  12352.852604545, 3.981496998 },
    {    0.040480,  15720.838784878, 2.546610123 },
    {    0.040184,     -7.113547001, 3.565975565 },
    {    0.036955,   3154.687084896, 5.071801441 },
    {    0.036564,   5088.628839767, 3.324679049 },
    {    0.036507,    801.820931124, 6.248866009 },
    {    0.034867,    522.577418094, 5.210064075 },
    {    0.033529,   9437.762934887, 2.404714239 },
    {    0.033477,   6062.663207553, 4.144987272 },
    {    0.032438,   6076.890301554, 0.749317412 },
    {    0.032423,   8827.390269875, 5.541473556 },
    {    0.030215,   7084.896781115, 3.389610345 },
    {    0.029862,  12139.553509107, 1.770181024 },
    {    0.029247, -71430.695617928, 4.183178762 },
    {    0.028244,  -6286.598968340, 5.069663519 },
    {    0.027567,   6279.552731642, 5.040846034 },
    {    0.025196,   1748.016413067, 2.901883301 },
    {    0.024816,  -1194.447010225, 1.087136918 },
    {    0.022567,   6133.512652857, 3.307984806 },
    {    0.022509,  10447.387839604, 1.460726241 },
    {    0.021691,  14143.495242431, 5.952658009 },
    {    0.020937,   8429.241266467, 0.652303414 },
    {    0.020322,    419.484643875, 3.735430632 },
    {    0.017673,   6812.766815086, 3.186129845 },
    {    0.017806,     73.297125859, 3.475975097 },
    {    0.016155,  10213.285546211, 1.331103168 },
    {    0.015974,  -2352.866153772, 6.145309371 },
    {    0.015949,   -220.412642439, 4.005298270 },
    {    0.015078,  19651.048481098, 3.969480770 },
    {    0.014751,   1349.867409659, 4.308933301 },
    {    0.014318,  16730.463689596, 3.016058075 },
    {    0.014223,  17789.845619785, 2.104551349 },
    {    0.013671,   -536.804512095, 5.971672571 },
    {    0.012462,    103.092774219, 1.737438797 },
    {    0.012420,   4690.479836359, 4.734090399 },
    {    0.011942,   8031.092263058, 2.053414715 },
    {    0.011847,   5643.178563677, 5.489005403 },
    {    0.011707,  -4705.732307544, 2.654125618 },
    {    0.011622,   5120.601145584, 4.863931876 },
    {    0.010962,      3.590428652, 2.196567739 },
    {    0.010825,    553.569402842, 0.842715011 },
    {    0.010396,    951.718406251, 5.717799605 },
    {    0.010453,   5863.591206116, 1.913704550 },
    {    0.010099,    283.859318865, 1.942176992 },
    {    0.009858,   6309.374169791, 1.061816410 },
    {    0.009963,    149.563197135, 4.870690598 },
    {    0.009370, 149854.400134205, 0.673880395 }
  };

  static const struct dtdb_coef bcoef[] = {
    {  102.156724,   6283.075849991, 4.249032005 },
    {    1.706807,  12566.151699983, 4.205904248 },
    {    0.269668,    213.299095438, 3.400290479 },
    {    0.265919,    529.690965095, 5.836047367 },
    {    0.210568,     -3.523118349, 6.262738348 },
    {    0.077996,   5223.693919802, 4.670344204 },
    {    0.059146,     26.298319800, 1.083044735 },
    {    0.054764,   1577.343542448, 4.534800170 },
    {    0.034420,   -398.149003408, 5.980077351 },
    {    0.033595,   5507.553238667, 5.980162321 },
    {    0.032088,  18849.227549974, 4.162913471 },
    {    0.029198,   5856.477659115, 0.623811863 },
    {    0.027764,    155.420399434, 3.745318113 },
    {    0.025190,   5746.271337896, 2.980330535 },
    {    0.024976,   5760.498431898, 2.467913690 },
    {    0.022997,   -796.298006816, 1.174411803 },
    {    0.021774,    206.185548437, 3.854787540 },
    {    0.017925,   -775.522611324, 1.092065955 },
    {    0.013794,    426.598190876, 2.699831988 },
    {    0.013276,   6062.663207553, 5.845801920 },
    {    0.012869,   6076.890301554, 5.333425680 },
    {    0.012152,   1059.381930189, 6.222874454 },
    {    0.011774,  12036.460734888, 2.292832062 },
    {    0.011081,     -7.113547001, 5.154724984 },
    {    0.010143,   4694.002954708, 4.044013795 },
    {    0.010084,    522.577418094, 0.749320262 },
    {    0.009357,   5486.777843175, 3.416081409 }
  };
 
  static const struct dtdb_coef ccoef[] = {
    {    0.370115,      0.000000000, 4.712388980 },
    {    4.322990,   6283.075849991, 2.642893748 },
    {    0.122605,  12566.151699983, 2.438140634 },
    {    0.019476,    213.299095438, 1.642186981 },
    {    0.016916,    529.690965095, 4.510959344 },
    {    0.013374,     -3.523118349, 1.502210314 }
  };

  static const struct dtdb_coef dcoef[] = {
    {    0.143388,   6283.075849991, 1.131453581 }
  };

  double t, dt = 0;
  double soltim, tas;
  double lsun, m, ljup, lsat, d;

  /* Time argument: Julian millennia since 2000.0 */
  t = (mjd - J2K) / (1000*JYR);

  /* Topocentric terms, if req. */
  if(u != 0 || z != 0) {
    /* Local mean solar time = UT1 + longitude, in radians */
    soltim = (fmod(mjd, 1.0) - dut1 / DAY) * TWOPI + longitude;

    /* Fundamental arguments, truncated to 1st order from Simon et al. 1994,
       mean dynamical ecliptic and equinox of date and "1992 values" */
    tas = t / 3600;

    lsun = fmod(280.46645683 + 1296027711.03429*tas, 360.0) * DEG_TO_RAD;  /* mean longitude of sun = earth + 180 degrees */
    m    = fmod(357.52910875 + 1295965810.48139*tas, 360.0) * DEG_TO_RAD;  /* mean anomaly = mean longitude - longitude of periapsis, wrapped to [0,360) */
    ljup = fmod( 34.35151874 +  109306899.89453*tas, 360.0) * DEG_TO_RAD;  /* mean longitude of Jupiter */
    lsat = fmod( 50.07744430 +   44046398.47038*tas, 360.0) * DEG_TO_RAD;  /* mean longitude of Saturn */
    d    = fmod(297.85019547 + 1602961601.2090 *tas, 360.0) * DEG_TO_RAD;  /* mean elongation of Moon from Sun */

    /* Moyer (1981) Eq. 38, reordered to put smallest terms first and
       constants changed for u,z in metres. */
    dt += (   2.9e-17     * u * sin(soltim + lsun - lsat)
	   +  1.00e-16    * u * sin(soltim - 2*m)
	   +  1.33e-16    * u * sin(soltim + lsun - ljup)
	   +  1.33e-16    * u * sin(soltim - d)
	   -  2.29e-16    * u * sin(soltim + 2*lsun + m)
	   +  5.312e-15   * u * sin(soltim - m)
	   -  1.3677e-14  * u * sin(soltim + 2*lsun)
	   -  1.3184e-13  * z * cos(lsun)
	   +  3.17679e-13 * u * sin(soltim));
  }

  /* Geocentric terms, Fairhead & Bretagnon (1990) */
  dt += 1.0e-6 * (dtdb_sum(t, acoef, sizeof(acoef)/sizeof(acoef[0])) +
		 (dtdb_sum(t, bcoef, sizeof(bcoef)/sizeof(bcoef[0])) +
		 (dtdb_sum(t, ccoef, sizeof(ccoef)/sizeof(ccoef[0])) +
		  dtdb_sum(t, dcoef, sizeof(dcoef)/sizeof(dcoef[0])) * t) * t) * t);

  return(dt);
}
